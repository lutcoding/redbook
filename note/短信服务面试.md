- 短信管理后台

  - 短信增删改查功能：例如查看某个业务对应的短信是否发送成功，查看业务剩余短信容量

  - 手动发送短信：

    - 补发
    - 单发
    - 群发
    - 定时发送
    - 支持复杂筛选目标用户，发送营销短信

  - 鉴权

    - 申请短信资源与审批
    - 鉴权：特定业务方只能使用特定的短信资源，例如某个业务一个月只能有十万短信容量

  - 可用性

    - 客户端限流

    - 短信重试策列

    - failover策略

      - 轮询的failover策略

      - 基于响应时间的failover策略

      - 基于错误率的failover策略

      - 同步转异步的failover策略

        

### 亮点

#### 鉴权设计

jwt token等机制来做鉴权，发送短信的业务方要携带自己从短信管理后台申请的token过来请求发送短信

#### 保证发送成功

- 收到发短信的请求，立刻存储到数据库
- 此时立刻尝试发送
- 发送失败，则有异步补偿机制，定时扫描数据库，发现还没发送成功，补发
- 缺点：可能重复发送，只能做到大部分实时操作，但是部分短信无法实时发送

#### 去重

业务方调用短信服务时，可能收到超时响应，此时会重试，但是如果前一个请求，你的短信服务实际上已经收到了，那么业务方重试就可能导致你这边重复发送。

解决方案：在请求里面带上`biz_type, biz_id`，在短信服务里面利用这两个字段做成唯一索引来去重，收到重复请求后，查看同样`biz_type, biz_id`是否发送成功：1.发送成功，返回成功响应。2.发送失败，返回失败响应

#### 可用性

1. 介绍你的重试机制，注意要强调业务方可以通过管理后台来配置他们的重试策略

2. 介绍限流机制

   a.  注意强调redis崩溃之后，你是限流还是不限流。如果回答限流，可以强调：在redis崩溃后会启用本地限流，也就是基于本地内存的各种限流算法实现

   b. 注意强调你有集群限流，以及针对业务方（也就是biz）的限流

3. 介绍failover策略

   a. 先介绍普通版本的failover策略：轮询

   b. 介绍升级版本的failover策略：同步转异步。也就是说，如果你发现短信服务商或者你的短信服务本身要撑不住了（如何判定），就会使用同步转异步，把消息转储到数据库（或消息队列---如果你知道延迟消息，可以用延迟消息）

#### 判定要不要触发异步的方案

1. 基于响应时间的，平均响应时间
   1. 使用绝对阈值，比如说直接发送的时候，（连续一段时间，或者连续N个请求）响应时间超过了 500ms，然后后续请求转异步
   2. 变化趋势，比如说当前一秒钟内的所有请求的响应时间比上一秒钟增长了 X%，就转异步
2. 基于错误率：一段时间内，收到 err 的请求比率大于 X%，转异步

#### 什么时候退出异步

1. 进入异步 N 分钟后
2. 保留 1% 的流量（或者更少），继续同步发送，判定响应时间/错误率

### 面试

该系统包含了一个**高可靠性**的短信服务模块，为了提供**可靠性、可观测性**，我首先抽象出来一个统一的发送短信的接口，在该接口上，我使用**装饰器模式**，引入了重试、客户端限流、同步转异步的方案

#### 重试：允许业务方可动态配置不同的重试方案，我提供了

1. 指数退避重试策略：在业务方申请短信服务的时候，允许传入一些参数比如：**初始间隔（比如第一次重试间隔1s）、增长趋势（下一次重试变2s或4s,这种增长趋势）、最大间隔实际 （比如8s）**。例：第一次间隔1s，第二次2s.....直到8s后，稳定在8s间隔
2. 等间隔重试策略：等间隔比如1s重试一次
3. 跨进程重试策略：将该请求存储到数据库，让另外一个节点调用

考虑到重试可能失败，我提供了**实时告警机制**，一旦重试达到某个阈值都还没有发送成功，就会发送告警，开发人员进行排查

#### 客户端限流

考虑到每个微服务使用短信服务的流量不一样，又考虑到短信服务提供商带有流量限制，为了避免触发短信提供商的限流，我在客户端提供了限流机制

我提供了多种限流策略

1. 滑动窗口算法：以当前时间为截止时间，往前取一段时间（比如60s），在这60s内最大请求量为一个特定阈值，如果超过该阈值，就触发限流，借助redis Zset有序集合实现滑动窗口算法，使用key来标识要限流的特定对象（比如某一个业务），score 用来存储请求的时间，首先先清空当前时间窗口外的记录，然后计算当前时间窗口内的计数，如果超过阈值，则执行限流，若未超过，则向有序集合中添加当前的时间戳作为score
2. 令牌算法：

如果触发了限流，我提供了同步转异步的方式来发送短信

#### 引入审批流程和鉴权

保证特定业务申请短信服务，防止浪费，引入jwt来鉴权